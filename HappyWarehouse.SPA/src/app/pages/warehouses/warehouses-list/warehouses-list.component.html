<div class="table-wrap card-white">
  <div class="d-flex justify-content-end mb-2">
    <button class="btn btn-primary" (click)="add()">New Warehouse</button>
  </div>

  <table class="table table-striped table-bordered">
    <thead>
      <tr><th>Name</th><th>City</th><th>Country</th><th>Address</th><th>Actions</th></tr>
    </thead>
    <tbody>
      <tr *ngFor="let r of rows">
        <td>{{ r.name }}</td>
        <td>{{ r.city }}</td>
        <td>{{ r.countryName }}</td>
        <td>{{ r.address }}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary me-1" (click)="toggleItems(r)">
            {{ expandedId === r.id ? 'Hide Items' : 'View Items' }}
          </button>
          <button class="btn btn-sm btn-outline-primary me-1" (click)="edit(r.id)">Edit</button>
          <button class="btn btn-sm btn-outline-danger" (click)="remove(r.id)">Delete</button>
        </td>
      </tr>


      <tr *ngFor="let r of rows" [hidden]="expandedId !== r.id">
        <td colspan="5">
          <div class="card-white">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Items in {{ warehouseName || r.name }}</h6>
              <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#itemModal"
                      (click)="Add()">
                Add Item
              </button>
            </div>

            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>SKU</th>
                  <th class="text-end">Qty</th>
                  <th class="text-end">Cost</th>
                  <th class="text-end">MSRP</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let i of items">
                  <td>{{ i.itemName }}</td>
                  <td>{{ i.skuCode }}</td>
                  <td class="text-end">{{ i.qty }}</td>
                  <td class="text-end">{{ i.costPrice }}</td>
                  <td class="text-end">{{ i.msrpPrice }}</td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#itemModal"
                            (click)="Edit(i.id)">
                      Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger" (click)="removeItem(i.id)">Delete</button>
                  </td>
                </tr>
                <tr *ngIf="items.length === 0">
                  <td colspan="6" class="text-muted">No items.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>


<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ editingId ? 'Edit Item' : 'Add Item' }}</h5>
        <button id="itemModalClose" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form [formGroup]="itemForm" (ngSubmit)="saveItem()">
        <div class="modal-body">
          <div class="mb-2">
            <label class="form-label">Item Name</label>
            <input class="form-control" formControlName="itemName"
                   [class.is-invalid]="(itemForm.controls.itemName.touched && itemForm.controls.itemName.invalid) || !!itemForm.controls.itemName.errors?.['server']">
          </div>
          <div class="invalid-feedback" *ngIf="itemForm.controls.itemName.touched && itemForm.controls.itemName.errors?.['required']">Item name is required.</div>
          <div class="invalid-feedback" *ngIf="itemForm.controls.itemName.errors?.['server']">{{ itemForm.controls.itemName.errors?.['server'] }}</div>

          <div class="mb-2">
            <label class="form-label">SKU</label>
            <input class="form-control" formControlName="skuCode"
                   [class.is-invalid]="!!itemForm.controls.skuCode.errors?.['server']">
            <div class="invalid-feedback" *ngIf="itemForm.controls.skuCode.errors?.['server']">{{ itemForm.controls.skuCode.errors?.['server'] }}</div>
          </div>
          <div class="row g-2">
            <div class="col">
              <label class="form-label">Qty</label>
              <input type="number" class="form-control" formControlName="qty" min="1"
                     [class.is-invalid]="(itemForm.controls.qty.touched && itemForm.controls.qty.invalid) || !!itemForm.controls.qty.errors?.['server']">
              <div class="invalid-feedback" *ngIf="itemForm.controls.qty.touched && (itemForm.controls.qty.errors?.['required'] || itemForm.controls.qty.errors?.['min'])">
                Qty must be 1 or more.
              </div>
              <div class="invalid-feedback" *ngIf="itemForm.controls.qty.errors?.['server']">{{ itemForm.controls.qty.errors?.['server'] }}</div>
            </div>
            <div class="col">
              <label class="form-label">Cost</label>
              <input type="number" class="form-control" formControlName="costPrice" min="0.01" step="0.01"
                     [class.is-invalid]="(itemForm.controls.costPrice.touched && itemForm.controls.costPrice.invalid) || !!itemForm.controls.costPrice.errors?.['server']">
              <div class="invalid-feedback" *ngIf="itemForm.controls.costPrice.touched && (itemForm.controls.costPrice.errors?.['required'] || itemForm.controls.costPrice.errors?.['min'])">
                Cost price must be 0 or more.
              </div>
              <div class="invalid-feedback" *ngIf="itemForm.controls.costPrice.errors?.['server']">{{ itemForm.controls.costPrice.errors?.['server'] }}</div>
            </div>
            <div class="col">
              <label class="form-label">MSRP</label>
              <input type="number" class="form-control" formControlName="msrpPrice"
                      [class.is-invalid]="(itemForm.controls.msrpPrice.touched && itemForm.controls.msrpPrice.invalid) || !!itemForm.controls.msrpPrice.errors?.['server']">
              <div class="invalid-feedback" *ngIf="itemForm.controls.msrpPrice.touched && (itemForm.controls.msrpPrice.errors?.['min'])">
                MSRP must be Postive.
              </div>
            <div class="invalid-feedback" *ngIf="itemForm.controls.msrpPrice.errors?.['server']">{{ itemForm.controls.msrpPrice.errors?.['server'] }}</div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-light" type="button" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" [disabled]="itemForm.invalid">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
